<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Questionnaire de santé naturelle</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body { background-color: #f0f2f5; }
    .card { max-width: 900px; margin: auto; border-radius: 1rem; }
    .required:after { content:" *"; color: red; }
  </style>
</head>
<body>
<div class="container py-5">
  <h1 class="text-center mb-5">Questionnaire de santé (Médecine naturelle)</h1>

  <form method="post" class="card p-4 shadow-sm bg-white" id="questionnaireForm" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="accordion" id="questionnaireAccordion">
      <!-- Section Informations personnelles -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingPersonal">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePersonal" aria-expanded="true">
            Informations personnelles
          </button>
        </h2>
        <div id="collapsePersonal" class="accordion-collapse collapse show" data-bs-parent="#questionnaireAccordion">
          <div class="accordion-body">
            <div class="row g-3">
              {% for field in form %}
                {% if field.name in 'civility first_name last_name email phone address birth_date gender' %}
                  <div class="col-md-6">
                    <label class="form-label {% if field.field.required %}required{% endif %}">{{ field.label }}</label>
                    {{ field|add_class:"form-control" }}
                    {% if field.errors %}
                      <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Section Santé / Physique -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingHealth">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHealth">
            Informations santé
          </button>
        </h2>
        <div id="collapseHealth" class="accordion-collapse collapse" data-bs-parent="#questionnaireAccordion">
          <div class="accordion-body">
            <div class="row g-3">
              {% for field in form %}
                {% if field.name in 'weight height is_pregnant lifestyle_notes' %}
                  <div class="col-md-6">
                    <label class="form-label {% if field.field.required %}required{% endif %}">{{ field.label }}</label>
                    {{ field|add_class:"form-control" }}
                    {% if field.errors %}
                      <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Section Antécédents -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingMedical">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMedical">
            Antécédents médicaux
          </button>
        </h2>
        <div id="collapseMedical" class="accordion-collapse collapse" data-bs-parent="#questionnaireAccordion">
          <div class="accordion-body">
            <div class="row g-3">
              {% for field in form %}
                {% if field.name in 'allergies medications medical_history family_history' %}
                  <div class="col-md-6">
                    <label class="form-label {% if field.field.required %}required{% endif %}">{{ field.label }}</label>
                    {{ field|add_class:"form-control" }}
                    {% if field.errors %}
                      <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Section Consentement -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConsent">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConsent">
            Consentement RGPD
          </button>
        </h2>
        <div id="collapseConsent" class="accordion-collapse collapse" data-bs-parent="#questionnaireAccordion">
          <div class="accordion-body">
            <div class="form-check">
              {% for field in form %}
                {% if field.name == 'consent' %}
                  {{ field|add_class:"form-check-input" }}
                  <label class="form-check-label required">{{ field.label }}</label>
                  {% if field.errors %}
                    <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4 d-flex justify-content-between align-items-center">
      <button type="submit" class="btn btn-success btn-lg">
        <i class="bi bi-check-circle"></i> Envoyer
      </button>
      <span class="text-muted small">Les champs marqués d’une * sont obligatoires</span>
    </div>
  </form>

  <footer class="text-center mt-5 text-muted">
    <p>Les données recueillies sont strictement confidentielles et destinées à un usage thérapeutique uniquement.</p>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function () {
    'use strict'
    const form = document.getElementById('questionnaireForm');

    form.addEventListener('submit', function (event) {
      let firstInvalid = null;
      const fields = form.querySelectorAll('.form-control, .form-check-input');
      fields.forEach(f => {
        f.classList.remove('is-invalid');
        if (!f.checkValidity()) {
          f.classList.add('is-invalid');
          if (!firstInvalid) firstInvalid = f;
        }
      });

      if (firstInvalid) {
        event.preventDefault();
        event.stopPropagation();
        // Scroll automatique vers la première erreur
        firstInvalid.scrollIntoView({behavior: 'smooth', block: 'center'});
        firstInvalid.focus();
      }
    }, false);
  })();
</script>
</body>
</html>
